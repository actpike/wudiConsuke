# SOW: バックグラウンド更新機能実装

---
date: 2025-07-12
status: Todo
category: Web監視機能
priority: High
estimated_effort: 2-3時間
---

## 概要
Popup画面上部に「更新」ボタンを追加し、ウディコンページを開かずにバックグラウンドで作品情報を取得・更新できる機能を実装する。現在はページを開いた状態でのみ解析可能だが、この機能により定期監視の完全自動化を実現する。

## 背景・経緯
- 現在の解析機能は正常動作（作品番号、タイトル、作者情報取得完了）
- Content Scriptベースのため、ページを開いた状態でのみ動作
- バックグラウンドでの自動更新機能が未実装
- ユーザーから手動でのバックグラウンド更新機能要望

## 要件定義

### 機能要件
1. **UI追加**
   - Popup画面上部（設定アイコンの左隣）に「更新」ボタン追加
   - 更新実行中は視覚的フィードバック表示（アイコン回転等）
   - 更新完了時は結果表示（新規/更新作品数）

2. **バックグラウンド更新機能**
   - Background ServiceWorkerによるページ取得
   - 取得したHTMLをPageParserで解析
   - 既存作品データとの差分検出・更新
   - Content Scriptを使用せずに完全バックグラウンド実行

3. **結果表示・通知**
   - 更新結果をPopup画面に表示
   - 新規作品・更新作品の詳細情報表示
   - エラー時の適切なメッセージ表示

4. **データ統合**
   - 既存のWebMonitor、PageParser、DataManagerとの連携
   - 取得情報：作品番号、タイトル、作者、更新日時、バージョン
   - 自動監視機能との整合性維持

### 非機能要件
- レスポンス時間：10秒以内
- エラー耐性：ネットワークエラー・解析失敗への対応
- Chrome拡張セキュリティ制約への完全準拠
- 既存機能への影響なし

## 技術仕様

### 修正対象ファイル
1. **popup.html**
   - 更新ボタンUI追加
   - ボタン配置とスタイル調整

2. **popup.js**
   - 更新ボタンイベントハンドラー追加
   - バックグラウンド更新実行メソッド
   - 更新結果表示機能

3. **css/popup.css**
   - 更新ボタンのスタイリング
   - 実行中アニメーション定義

4. **js/webMonitor.js**
   - Background ServiceWorker用の更新メソッド追加
   - popup.jsからの呼び出し対応

### 実装アーキテクチャ
```
Popup UI (更新ボタン)
  ↓
popup.js (イベントハンドラー)
  ↓  
webMonitor.js (バックグラウンド実行)
  ↓
pageParser.js (HTML解析)
  ↓
dataManager.js (データ更新)
  ↓
Popup UI (結果表示)
```

### API設計
```javascript
// popup.js
async performBackgroundUpdate() {
  // バックグラウンド更新実行
  // 結果表示・エラーハンドリング
}

// webMonitor.js  
async executeBackgroundUpdate() {
  // ページ取得・解析・データ更新
  // 結果返却
}
```

## 実装手順

### Phase 1: UI実装（30分）
- popup.htmlに更新ボタン追加
- CSSでスタイリング・アニメーション設定
- popup.jsにイベントハンドラー基本枠組み

### Phase 2: バックグラウンド機能実装（90分）
- webMonitor.jsにバックグラウンド更新メソッド追加
- fetchContestPage()の既存機能活用
- parseContestPage()との連携実装
- データ更新・差分検出機能

### Phase 3: 結果表示・統合（30分）
- 更新結果のPopup表示機能
- エラーハンドリング・ユーザビリティ向上
- 既存監視機能との動作確認

### Phase 4: テスト・検証（30分）
- 手動更新機能テスト
- エラーケーステスト
- パフォーマンス確認

## 成果物

### 必須成果物
- 更新ボタン付きPopup UI
- バックグラウンド更新機能
- 結果表示・エラーハンドリング機能
- 動作確認テスト結果

### 検証基準
- ページを開かずに作品情報取得成功
- 新規作品・更新作品の正確な検出
- 更新結果のPopup表示
- エラー時の適切なメッセージ表示
- 既存機能への影響なし

## リスク・注意事項

### 技術リスク
- Background ServiceWorkerでのCORS制約
- HTMLパースの動作差異（Content Script vs Background）
- 大量データ処理時のパフォーマンス

### 対応策
- fetch APIでのheaders設定最適化
- pageParser.jsのブラウザ環境対応確認
- 処理中UI表示によるユーザビリティ確保

## 取得項目仕様
現在の解析機能で正常取得中：
- **作品番号**: エントリー番号【1】→ "1"
- **タイトル**: 『片道勇者（ｴﾝﾄﾘｰ見本）』→ "片道勇者（ｴﾝﾄﾘｰ見本）"
- **作者**: "SmokingWOLF"（現在output未表示だが内部取得済み想定）
- **更新日時/バージョン**: 【ダウンロード】後の日付情報（現在output未表示だが内部取得済み想定）

## スケジュール
- UI実装: 0.5時間
- バックグラウンド機能実装: 1.5時間
- 結果表示・統合: 0.5時間
- テスト・検証: 0.5時間

**合計見積工数: 3.0時間**

## 補足事項
- 既存のWebMonitor基盤を最大限活用
- Content Script依存からの脱却が主目的
- 将来的な定期自動監視機能への基盤構築