---
title: "リアルタイム平均計算における重複カウント問題の修正"
status: "In Progress"
priority: "High"
created_date: "2025-07-27"
estimated_hours: "2"
assignee: "Claude"
category: "Bug Fix"
related_files: ["wodicon_helper/js/navigation.js"]
---

# SOW: リアルタイム平均計算における重複カウント問題の修正

## 1. プロジェクト概要

### 1.1 背景
個別詳細画面でのリアルタイム平均バー更新機能において、現在編集中のゲームが既存データと重複してカウントされ、母数が本来より+1される問題が発生している。

### 1.2 問題の詳細
- **発生タイミング**: 個別詳細画面で評価スライダーを操作し、リアルタイム平均バー更新が実行される時のみ
- **正常動作**: 個別作品を開いた直後は正しく平均5.5が表示される
- **異常動作**: No1=10, No2=1の状態でNo2を変更時、(10+1+1)/3=4が平均として算出される
- **期待値**: (10+1)/2=5.5が正しい平均値
- **原因**: `displayAverageRating(currentFormRating)`内で現在編集中ゲームの重複カウントが発生
- **処理の違い**:
  - 初期表示: `displayAverageRating()` - 正常動作
  - リアルタイム更新: `displayAverageRating(currentFormRating)` - 重複カウント発生

### 1.3 影響範囲
- 個別詳細画面での評価スライダー操作時のリアルタイム平均バー表示
- ユーザーが視覚的に確認する平均値の正確性
- データ分析・評価判断への影響

## 2. 要件定義

### 2.1 機能要件
1. **重複排除ロジック**: 現在編集中ゲームが既存データセットに含まれる場合の適切な処理
2. **母数計算の正確性**: リアルタイム更新時の母数が実際のゲーム数と一致すること
3. **既存機能の保持**: 画面開時の初期平均計算ロジックは変更しない

### 2.2 非機能要件
1. **パフォーマンス**: 50ms以内のリアルタイム更新レスポンス維持
2. **データ整合性**: 保存データへの影響なし（一時的な計算のみ）
3. **互換性**: 既存の`displayAverageRating()`との完全互換性

### 2.3 制約条件
- Chrome拡張機能のManifest V3制約下での動作
- 外部ライブラリ不使用での実装
- 既存UIコンポーネントとの整合性維持

## 3. 技術仕様

### 3.1 対象ファイル
- **メインファイル**: `wodicon_helper/js/navigation.js`
- **影響メソッド**: `displayAverageRating(currentFormRating)`

### 3.2 修正箇所の特定
```javascript
// 問題のある箇所（navigation.js:408-424）
if (currentFormRating && this.editingGameId) {
  playedGames = [...playedGames];
  const currentGameIndex = playedGames.findIndex(g => g.id === this.editingGameId);
  const currentGameData = {
    id: this.editingGameId,
    rating: currentFormRating,
    is_played: window.gameDataManager.isRatingComplete(currentFormRating)
  };
  
  if (currentGameIndex >= 0) {
    // 既存ゲームの評価を一時的に置き換え ← 正常動作
    playedGames[currentGameIndex] = { ...playedGames[currentGameIndex], ...currentGameData };
  } else if (currentGameData.is_played) {
    // 新規ゲームで評価完了の場合のみ追加 ← 重複カウントの原因
    playedGames.push(currentGameData);
  }
}
```

### 3.3 修正方針
1. **重複判定の強化**: 編集中ゲームがplayedGames配列に含まれるかの正確な判定
2. **条件分岐の明確化**: 新規ゲーム vs 既存ゲーム編集の処理分離
3. **デバッグログの追加**: 重複カウント検出のためのログ出力

## 4. 実装計画

### 4.1 Phase 1: 問題分析・調査（30分）
- 初期表示 vs リアルタイム更新での処理の違いを詳細分析
- `displayAverageRating()` (引数なし) と `displayAverageRating(currentFormRating)` の動作比較
- `playedGames.findIndex()`による重複判定ロジックの問題点特定
- 現在編集中ゲームがplayedGames配列に既に含まれているかの判定精度確認

### 4.2 Phase 2: 修正実装（60分）
- 重複判定ロジックの改善
- 新規 vs 既存ゲーム判定の精度向上
- エラーハンドリングの追加

### 4.3 Phase 3: テスト・検証（30分）
- 重複カウント問題の解消確認
- 複数シナリオでの動作検証
- 既存機能への影響確認

## 5. テストケース

### 5.1 重複カウント確認テスト
| ケース | 初期状態 | 操作 | 期待結果 | 初期表示確認 | リアルタイム更新確認 |
|--------|----------|------|----------|--------------|-------------------|
| 1 | No1=10, No2=1 | 詳細画面を開く | 平均=(10+1)/2=5.5 | ✅正常表示 | - |
| 1-2 | 同上 | No2を1→5に変更 | 平均=(10+5)/2=7.5 | - | 🔍要検証（母数=2） |
| 2 | No1=8, No2=4, No3=6 | 詳細画面を開く | 平均=(8+4+6)/3=6.0 | ✅正常表示 | - |
| 2-2 | 同上 | No2を4→10に変更 | 平均=(8+10+6)/3=8.0 | - | 🔍要検証（母数=3） |
| 3 | 新規ゲーム | 詳細画面を開く | 平均線非表示 | ✅正常表示 | - |
| 3-2 | 同上 | 初回評価入力 | 平均に新規ゲームのみ反映 | - | 🔍要検証（母数=1） |

### 5.2 境界値テスト
- 評価完了直前（5項目入力済み）での6項目目入力
- 全項目null状態からの初回入力
- 既存評価ありゲームでの評価変更

### 5.3 パフォーマンステスト
- 50ms以内のリアルタイム更新レスポンス確認
- 大量データ（100ゲーム以上）での動作確認

## 6. 品質保証

### 6.1 コードレビュー観点
- 重複判定ロジックの正確性
- エッジケース処理の網羅性
- 既存機能への影響最小化

### 6.2 リグレッションテスト
- **初期表示の正常動作維持**: 画面開時の`displayAverageRating()`が引き続き正確に動作すること
- **既存機能への影響なし**: 保存機能、合計点計算、星表示等への影響がないこと
- **パフォーマンス維持**: リアルタイム更新が50ms以内で完了すること
- **データ整合性**: 実際のストレージデータに影響を与えないこと

## 7. リスク管理

### 7.1 技術リスク
- **ゲームID判定の複雑化**: 新規ゲーム判定ロジックの複雑化によるバグ誘発
- **パフォーマンス劣化**: 判定処理追加による処理時間増加

### 7.2 対策
- 段階的実装による影響範囲の最小化
- 十分なテストケースによる品質確保
- ロールバック可能な実装方針

## 8. 成果物

### 8.1 成果物一覧
- 修正された`navigation.js`
- テスト結果レポート
- 修正内容のドキュメント

### 8.2 完了条件
- [ ] 重複カウント問題の完全解消
- [ ] 全テストケースの通過
- [ ] 既存機能の正常動作確認
- [ ] パフォーマンス基準（50ms以内）の達成

## 9. 承認

### 9.1 技術承認
- 修正方針の技術的妥当性確認
- 影響範囲の適切性評価

### 9.2 品質承認
- テスト結果の妥当性確認
- リリース可能品質の達成確認

---

**注記**: 本SOWは緊急度の高いバグ修正であり、迅速な対応が求められる。実装は既存の正確な平均計算ロジックを最大限活用し、最小限の変更で問題解決を図ることを基本方針とする。