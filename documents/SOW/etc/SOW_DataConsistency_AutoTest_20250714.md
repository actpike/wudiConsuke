---
title: "Chrome拡張機能データ一貫性問題の自動テスト・修正SOW"
status: "Todo"
priority: "High"
created_date: "2025-07-14"
estimated_hours: 4
assignee: "Claude"
project: "WodiConsuke"
category: "Bug Fix & Automation"
---

# Chrome拡張機能データ一貫性問題の自動テスト・修正SOW

## 📋 概要

Chrome拡張機能「ウディこん助」における更新日データ一貫性問題の自動テストシステム構築と根本修正を行う。

## 🎯 目的

1. **データ一貫性問題の自動再現**: 手動テストに依存しない自動化システムの構築
2. **根本原因の特定**: PlaywrightMCPを用いたデータフロー全体の追跡
3. **統一的データ処理の実装**: 複数存在するデータフィールド名の統一

## 🚨 問題の詳細

### 現在の問題状況
- **Web取得段階**: `"[7/13]Ver1.2に更新 → ご意見/バグ報告BBS"` ✅ 正常
- **DataManager保存**: `"[7/13]Ver1.2に更新 → ご意見/バグ報告BBS"` ✅ 正常
- **詳細画面表示**: `lastUpdate: undefined` ❌ 問題発生

### 根本原因仮説
- **複数のデータフィールド名**: `lastUpdate`, `last_update`, `version`, `updated_at`
- **データ処理経路の分岐**: バックグラウンド更新 vs 詳細画面表示
- **フィールド名の不整合**: 保存時と取得時で異なる名前を使用

## 🔧 実装内容

### Phase 1: 自動テストシステム構築 (2h)

#### 1.1 PlaywrightMCP テストフレームワーク実装
- **ファイル**: `scripts/mcp/playwright/test-data-consistency.js`
- **機能**:
  - Chrome拡張機能の自動ロード
  - 全データ削除の自動実行
  - バックグラウンド更新の自動実行
  - データ一貫性の自動検証
  - 詳細画面表示の自動シミュレーション

#### 1.2 データフロー追跡システム
- **追跡対象**:
  - `webMonitor.js` → `dataManager.js` → `navigation.js`
  - 各段階でのデータフィールド名確認
  - Storage構造の詳細分析

#### 1.3 自動レポート生成
- **レポート内容**:
  - 問題の再現確認
  - データフィールド名の不整合検出
  - 保存・取得時の差異分析

### Phase 2: 根本修正実装 (2h)

#### 2.1 データフィールド名統一化
- **対象ファイル**: `dataManager.js`, `webMonitor.js`, `navigation.js`
- **統一方針**:
  - 主要フィールド: `lastUpdate` に統一
  - 互換性保持: 既存データのマイグレーション
  - 新規追加: 統一フィールド名で処理

#### 2.2 データ処理メソッドの統一
- **実装内容**:
  - 共通データ変換メソッドの作成
  - 全データ操作の統一化
  - バックグラウンド更新と詳細画面表示の処理統合

#### 2.3 後方互換性の保証
- **マイグレーション処理**:
  - 既存データの自動変換
  - 異なるフィールド名の自動マッピング
  - データ完全性の保証

## 🧪 テストケース

### 自動テストシナリオ

#### シナリオ1: 問題再現テスト
1. **前提条件**: 拡張機能が正常にロードされている
2. **実行手順**:
   - 全データ削除実行
   - バックグラウンド更新実行
   - 保存データの確認
   - 詳細画面表示の確認
3. **期待結果**: 問題の自動再現とログ記録

#### シナリオ2: データ一貫性検証
1. **前提条件**: 作品データが存在する
2. **実行手順**:
   - 全作品データの取得
   - 各作品のフィールド名確認
   - データフィールドの不整合検出
3. **期待結果**: 一貫性問題の自動検出

#### シナリオ3: 修正後検証
1. **前提条件**: 修正が実装済み
2. **実行手順**:
   - 同様のテストを実行
   - 修正前後の比較
3. **期待結果**: 問題の完全解決確認

## 📊 成果物

### 1. 自動テストシステム
- **メインテスト**: `test-data-consistency.js`
- **補助テスト**: `test-wodicon-extension.js`
- **レポート**: JSON形式の詳細分析結果

### 2. 修正コード
- **dataManager.js**: 統一データ処理メソッド
- **webMonitor.js**: 統一フィールド名での保存
- **navigation.js**: 統一フィールド名での取得

### 3. ドキュメント
- **テスト実行手順**: 自動テストの実行方法
- **修正内容詳細**: 変更点と理由の説明
- **今後の保守指針**: 統一的データ処理の維持方法

## 🔄 実行計画

### Day 1 (2h)
- **09:00-10:00**: PlaywrightMCP テストシステム構築
- **10:00-11:00**: 自動テスト実行・問題再現確認

### Day 2 (2h)
- **14:00-15:00**: データフィールド名統一化実装
- **15:00-16:00**: 修正後テスト・検証完了

## 🎯 完了条件

### 必須条件
- [ ] 自動テストでの問題再現確認
- [ ] データフィールド名の完全統一
- [ ] 詳細画面での正常な更新日表示
- [ ] 既存データの後方互換性保証

### 推奨条件
- [ ] 全テストケースの自動実行成功
- [ ] 継続的なテスト実行環境の構築
- [ ] 統一的データ処理の全体適用

## 📋 注意事項

### 技術的制約
- Chrome Manifest V3制約への対応
- PlaywrightMCP の拡張機能アクセス権限
- Storage API の非同期処理

### 品質保証
- 既存機能への影響なし
- データ整合性の完全保証
- ユーザー体験の向上

### 今後の拡張性
- 他のデータ一貫性問題への応用
- 自動テストシステムの継続利用
- 統一的データ処理の全プロジェクト適用

## 🎯 期待効果

### 短期効果
- 詳細画面での正常な更新日表示
- データ一貫性問題の根本解決
- 手動テストからの脱却

### 長期効果
- 統一的データ処理による保守性向上
- 自動テストによる品質保証
- 将来のバグ発生リスク軽減

---

**作成者**: Claude  
**レビュー**: 未  
**承認**: 未  
**開始予定日**: 2025-07-14  
**完了予定日**: 2025-07-14