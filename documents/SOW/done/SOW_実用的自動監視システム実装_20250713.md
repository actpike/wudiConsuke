# SOW: 実用的自動監視システム実装

---
project_name: "実用的自動監視システム実装"
status: "Done"
owner: "actpike"
created_at: "2025-07-13"
updated_at: "2025-07-13"
category: "Web監視機能改善"
priority: "High"
estimated_effort: "1.5-2時間"
---

- **Project Name:** `実用的自動監視システム実装`
- **Creation Date:** `2025-07-13`
- **Revision History:**
  - `v1.0 (2025-07-13): Initial draft`

#### 1. Project Purpose & Background

現在の自動監視機能はChrome Manifest V3の制約により、真の自動実行が困難であることが判明した。ユーザーの日常的なブラウザ利用パターンに合わせた実用的な自動監視システムを実装し、手動操作なしでウディコン作品の監視を実現する。

**背景**:
- 既存の15分定期監視がService Worker制約により機能しない
- ユーザーは自動監視機能があると認識しているが実際は動作していない
- 手動監視のみでは利便性が大幅に低下
- Chrome拡張機能の技術制約内での現実的な解決策が必要

#### 2. Scope of Work

**コア機能実装**:
- ウディコンサイト訪問時の自動監視実行（Content Script活用）
- ポップアップ開時の定期自動チェック（前回監視から一定時間経過時）
- 既存の手動監視機能との統合・共存
- 監視実行状況のユーザーフィードバック改善

**技術実装詳細**:
- content.js強化：ページ読み込み完了時の自動監視トリガー
- popup.js拡張：初期化時の自動監視判定・実行ロジック
- webMonitor.js改修：自動/手動監視の統一インターフェース
- 監視履歴・状況表示の改善

**ユーザー体験向上**:
- 自動監視実行時の視覚的フィードバック
- 前回監視時刻の明確な表示
- 「次回自動監視予定」の分かりやすい説明
- 自動監視ON/OFF設定の追加

**Web自動監視機能の廃止**:
- 技術的制約により自動監視が困難であるため、該当機能はオプション項目やソースを削除する

#### 3. Out of Scope

**技術的制約による除外項目**:
- 完全なバックグラウンド定期監視（Service Worker制約のため不可能）
- ブラウザ非使用時の監視実行
- 外部サーバーを使用した監視システム
- 他ブラウザ対応

**設計方針による除外項目**:
- 複雑な監視スケジューリング機能
- 高度な監視カスタマイズ機能
- リアルタイム監視（数分間隔等）
- 監視結果の外部連携（メール等）

#### 4. Deliverables

**必須成果物**:
- ウディコンサイト自動監視機能（content.js）
- ポップアップ自動監視機能（popup.js）
- 統合監視管理システム（webMonitor.js改修）
- 監視状況UI改善（popup.html/css）

**品質基準**:
- ウディコンサイト訪問時の100%自動実行
- ポップアップ開時の条件付き自動実行
- 既存手動監視機能との完全互換性
- 監視実行の明確なユーザーフィードバック

#### 5. Technical Specifications

**1. ウディコンサイト自動監視**
```javascript
// content.js 実装仕様
window.addEventListener('load', async () => {
  // ウディコンページ判定
  if (location.href.includes('Contest/entry.shtml')) {
    // 自動監視実行
    await performAutoMonitoring('content_script');
  }
});
```

**2. ポップアップ自動監視**
```javascript
// popup.js 実装仕様
document.addEventListener('DOMContentLoaded', async () => {
  const lastCheck = await getLastCheckTime();
  const hoursSinceCheck = calculateHoursSince(lastCheck);
  
  // 1時間以上経過していれば自動監視
  if (hoursSinceCheck >= 1) {
    await performAutoMonitoring('popup_startup');
  }
});
```

**3. 監視統合インターフェース**
```javascript
// webMonitor.js 拡張仕様
class WebMonitor {
  async performAutoMonitoring(source) {
    // source: 'content_script' | 'popup_startup' | 'manual'
    // 統一された監視処理
  }
}
```

#### 6. Implementation Plan

**Phase 1: Content Script自動監視 (45分)**
- content.js拡張：ページ読み込み検知と自動監視実行
- ウディコンページ判定ロジック実装
- 既存webMonitor.jsとの連携
- 自動監視実行時の結果保存

**Phase 2: ポップアップ自動監視 (45分)**
- popup.js初期化時の自動監視判定
- 前回監視時刻からの経過時間計算
- 条件付き自動監視実行（1時間以上経過時）
- 監視中UI表示改善

**Phase 3: UI・UX改善 (30分)**
- 自動監視状況の視覚的表示
- 「前回監視: ○時間前」表示
- 「次回自動監視: サイト訪問時/ポップアップ開時」説明
- 自動監視ON/OFF設定追加

**合計見積工数: 2時間**

#### 7. User Experience Flow

**シナリオ1: ウディコンサイト訪問**
```
1. ユーザーがウディコンページを開く
2. ページ読み込み完了と同時に自動監視実行
3. 新規/更新作品があれば通知表示
4. 監視結果を拡張機能データに保存
```

**シナリオ2: 拡張機能利用**
```
1. ユーザーが拡張機能ポップアップを開く
2. 前回監視から1時間以上経過していれば自動監視
3. 監視中は「更新確認中...」表示
4. 完了後、通常のポップアップ表示
```

**シナリオ3: 手動監視**
```
1. 従来通りの手動監視ボタン
2. 自動監視と同じ処理を実行
3. 手動/自動の区別は内部ログのみ
```

#### 8. Success Criteria

**機能面**:
- ウディコンサイト訪問時の自動監視実行率100%
- ポップアップ開時の条件付き自動監視動作
- 既存手動監視機能の完全保持

**ユーザビリティ面**:
- 自動監視実行がユーザーに分かりやすく表示される
- 「いつ監視されるか」が明確に理解できる
- 手動監視との使い分けが直感的

**技術面**:
- Content ScriptとPopupの確実な連携
- 監視処理の重複実行防止
- エラー時の適切なフォールバック

#### 9. Configuration & Settings

**新規設定項目**:
- 自動監視ON/OFF切り替え
- ポップアップ自動監視の間隔設定（1時間/3時間/6時間）
- ウディコンサイト自動監視ON/OFF

**既存設定との関係**:
- 既存の「監視モード」「注目作品設定」は継続利用
- 手動監視ボタンは従来通り利用可能
- 通知設定は自動/手動共通で適用

#### 10. Risk Management

**技術リスク**:
- **Content Script実行失敗**: try-catch + エラーログで対応
- **ポップアップ初期化遅延**: Promise.allで並行処理
- **重複監視実行**: 実行中フラグでの排他制御

**ユーザー体験リスク**:
- **監視頻度の過多**: 最小間隔制限（30分）の実装
- **予期しない監視実行**: 明確な実行通知とON/OFF設定
- **既存機能への影響**: 段階的展開とロールバック準備

#### 11. Testing Strategy

**機能テスト**:
- ウディコンサイト訪問時の自動監視動作確認
- ポップアップ開時の条件付き監視確認
- 手動監視との併用テスト

**エッジケーステスト**:
- 短時間での連続サイト訪問
- ポップアップ高速開閉
- ネットワークエラー時の動作

**ユーザビリティテスト**:
- 自動監視の発生タイミング理解度
- 設定画面の分かりやすさ
- 監視状況表示の適切性

#### 12. Deployment Plan

**段階的リリース**:
1. Content Script自動監視のみ先行リリース
2. 動作確認後、ポップアップ自動監視追加
3. UI改善の最終適用

**ロールバック準備**:
- 従来の手動監視機能は完全保持
- 自動監視ON/OFF設定で即座に無効化可能
- 設定リセット機能での初期状態復帰

#### 13. Post-Implementation

**監視・改善**:
- 自動監視実行頻度の分析
- ユーザーの利用パターン把握
- エラー発生率の監視

**将来拡張**:
- 新しいタブページでの監視機能
- より高度な監視スケジューリング
- 監視結果の統計・分析機能

**ユーザーサポート**:
- 自動監視機能の説明文書更新
- 設定画面での分かりやすいヘルプ
- トラブルシューティングガイド