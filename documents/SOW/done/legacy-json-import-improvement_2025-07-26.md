# SOW (Statement of Work)

---
project_name: "古いJSONフォーマット互換性向上・インポート堅牢化"
status: "Done"
owner: "Claude Code"
created_at: "2025-07-26"
updated_at: "2025-07-26"
---

- **Project Name:** `古いJSONフォーマット互換性向上・インポート堅牢化`
- **Creation Date:** `2025-07-26`
- **Revision History:**
  - `v1.0 (2025-07-26): Initial draft`

#### 1. Project Purpose & Background

現在、古いJSONフォーマット（`wodicon_games`キー使用）のインポート時に、データが正しく年度別システムに反映されない問題が発生している。具体的には以下の事象が確認されている：

- `documents/tmp/wodicon_data_2025-07-26T01-46-28.json` のような古いフォーマットをインポートしても、削除済み年度リスト（`deleted_years`）による阻害で年度が復活しない
- 評価データ構造の違い（`rating: null` vs 新フォーマットの6項目評価）による変換不備
- インポート後の年度初期化タイミングの問題

本プロジェクトは、これらの互換性問題を根本的に解決し、ユーザが過去のデータを確実にインポートできる堅牢なシステムを構築することを目的とする。

#### 2. Scope of Work

以下の作業を実施する：

- **JSONフォーマット検出・変換機能の強化**
  - 古いフォーマット（`wodicon_games`）の確実な検出機能実装
  - `wodicon_settings`, `wodicon_metadata` 等の関連データの完全変換対応
  - バージョン情報による自動判定ロジック追加

- **削除済み年度リスト管理の改善**
  - 古いJSONインポート時の削除済み年度リスト自動クリア機能の改善
  - インポート前の年度初期化プロセス最適化
  - 削除済み年度リストクリア後の確実な年度復活保証

- **評価データ構造変換機能の実装**
  - 古いフォーマットの `rating: null` から新フォーマットの6項目評価への変換
  - 既存評価データがある場合の適切なマッピング処理
  - 評価データ欠損時のデフォルト値設定

- **インポート処理の堅牢化**
  - インポート処理の段階的実行（前処理→変換→後処理）
  - 各段階でのエラーハンドリング強化
  - インポート失敗時のロールバック機能実装

- **インポート検証機能の追加**
  - インポート完了後のデータ整合性チェック
  - 予期されるゲーム数とインポート結果の照合
  - インポート結果の詳細ログ出力

- **ユーザビリティ向上**
  - インポート進行状況の可視化
  - インポート成功/失敗の明確な通知
  - インポート後の推奨アクション案内（ページリロード等）

#### 3. Out of Scope

以下は本プロジェクトの対象外とする：

- 新しいJSONフォーマットの変更や拡張
- CSVインポート機能の修正や改善
- 年度管理システム自体の構造変更
- UI/UXの大幅な変更（必要最小限の通知改善のみ）
- パフォーマンス最適化（機能実装優先）

#### 4. Deliverables

以下の成果物を提供する：

- **強化されたdataManager.js**
  - 改善されたimportData()メソッド
  - 新しいlegacyJsonConverter()メソッド
  - インポート検証機能

- **更新されたyearManager.js**
  - インポート前処理機能
  - 削除済み年度管理の改善

- **テスト用古いJSONファイル**
  - 異なるパターンの古いフォーマットファイル
  - インポート検証用のテストケース

- **ドキュメント更新**
  - CLAUDE.mdの古いJSONインポート関連記述更新
  - インポート手順の明確化

#### 5. Acceptance Criteria

以下の条件を満たした場合に完了とする：

- 指定された古いJSONファイル（`wodicon_data_2025-07-26T01-46-28.json`）が正常にインポートされる
- インポート後、該当年度（2025年）が利用可能年度リストに表示される
- インポートされたゲームデータが正しい形式で保存され、詳細画面で表示可能
- 削除済み年度リストによる阻害が確実に解除される
- インポート処理中のエラーが適切にハンドリングされ、ユーザに分かりやすく通知される

#### 6. Timeline

- **Phase 1 (Day 1)**: 現状分析・設計（古いJSONフォーマット詳細調査、変換仕様策定）
- **Phase 2 (Day 1-2)**: コア機能実装（フォーマット変換、削除済み年度管理改善）
- **Phase 3 (Day 2)**: 検証・テスト（指定ファイルでの動作確認、エッジケーステスト）
- **Phase 4 (Day 2)**: 最終調整・ドキュメント更新

#### 7. Dependencies & Constraints

- **Dependencies:**
  - 既存のyearManager.jsとdataManager.jsの動作理解
  - Chrome拡張機能のストレージ制限（5MB）への配慮
  - 現在の年度管理システムとの互換性維持

- **Constraints:**
  - 既存の正常動作しているインポート機能への影響回避
  - Chrome Manifest V3制約下での実装
  - 完全ローカル動作の維持（外部API使用不可）

#### 8. Success Metrics

- 古いJSONファイルのインポート成功率: 100%
- インポート後の年度表示成功率: 100%
- インポート処理エラー時の適切な通知率: 100%
- ユーザが理解可能な形でのインポート結果表示: 実装完了