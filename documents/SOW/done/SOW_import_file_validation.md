---
project_name: "インポートファイル検証機能実装"
status: "Done"
owner: "Claude Code"
created_at: "2025-07-27"
updated_at: "2025-07-27"
---

### SOW (Statement of Work)

- **Project Name:** `インポートファイル検証機能実装`
- **Creation Date:** `2025-07-27`
- **Revision History:**
  - `v1.0 (2025-07-27): Initial draft`

#### 1. Project Purpose & Background

現状のウディこん助Chrome拡張機能では、データインポート時に古いJSONフォーマットや不適切なファイル形式を受け入れようとしているが、正しく反映されない問題が発生している。具体的には：

- **古いJSONフォーマット問題**: 過去バージョンのデータ構造（`wodicon_games`等）が混在し、新フォーマット（`games`）との整合性が取れない
- **無効なJSONファイル**: 構文エラーや必須フィールド不足のファイルでもエラーメッセージが不明確
- **CSVフォーマット検証不足**: 不正なCSV構造でもインポート処理が実行され、データ破損やエラーが発生

これらの問題を根本的に解決するため、ファイル形式と内容の事前検証機能を実装し、不適切なファイルは明確なメッセージで弾く仕組みを構築する。

#### 2. Scope of Work

- **JSONファイル検証機能実装**
  - JSON構文の正当性チェック（JSON.parseエラーハンドリング強化）
  - 必須フィールド存在確認（`games`配列、各ゲームオブジェクトの必須プロパティ）
  - データ型検証（文字列、数値、ブール値の型チェック）
  - フォーマットバージョン判定（v1.0.3以降の新フォーマットのみ受け入れ）
  
- **CSVファイル検証機能実装**
  - CSVヘッダー行の正当性チェック（必須カラム: No, 作品名, 熱中度, 斬新さ, 物語性, 画像音響, 遊びやすさ, その他）
  - データ行の形式検証（カラム数一致、評価値の範囲チェック）
  - 文字エンコーディング検証（UTF-8前提）
  - 重複データ検出とアラート

- **エラーメッセージ体系の統一**
  - ファイル形式別の詳細エラーメッセージ作成
  - ユーザーフレンドリーな修正提案の提示
  - エラーログの詳細記録（window.errorHandler統合）

- **検証UI強化**
  - インポート前のファイルプレビュー機能
  - 検証結果の可視化（有効/無効アイテム数、エラー詳細リスト）
  - 検証通過後の確認ダイアログ改善

#### 3. Out of Scope

- **古いフォーマットの自動変換機能**: 変換処理は複雑でデータ破損リスクが高いため、明確に拒否する方針
- **他ファイル形式対応**: Excel（.xlsx）、XML等の対応は含まない
- **リアルタイムファイル検証**: ファイル選択時点での検証は含まない（インポート実行時のみ）
- **バックアップ機能強化**: インポート前の自動バックアップ作成は含まない
- **データマージ機能**: 既存データとの統合処理は現状維持

#### 4. Deliverables

- **実装ファイル:**
  - `js/fileValidator.js` - 新規作成：ファイル検証専用モジュール
  - `js/options.js` - 修正：検証機能統合、エラーハンドリング強化
  - `js/dataManager.js` - 修正：importData()メソッドの検証処理追加

- **検証関連:**
  - 各ファイル形式の検証テストケース一覧
  - エラーメッセージ一覧表（日本語）
  - 検証ロジックの単体テスト実装

- **ドキュメント:**
  - インポートファイル要件仕様書（対応フォーマット、必須フィールド等）
  - ユーザー向けトラブルシューティングガイド

#### 5. Assumptions & Constraints

- **Assumptions:**
  - ユーザーはv1.0.2以降の新フォーマットJSONファイルのみを使用する意向がある
  - CSVファイルは標準的なRFC 4180準拠形式であること
  - Chrome拡張機能のファイルアクセス制限内で実装可能であること

- **Constraints:**
  - Chrome Manifest V3のセキュリティ制約（eval()禁止、CSP準拠）
  - ファイル読み込みはFileReader APIのみ使用可能
  - メモリ使用量制限（大容量ファイルの処理制限）
  - 既存のwindow.errorHandler、window.constantsアーキテクチャとの互換性維持

#### 6. Team & Roles

- **Client-side:**
  - Project Lead: `ユーザー（actpike）`
  - 要件定義・テスト: `ユーザー`

- **Vendor/Developer-side:**
  - 実装担当: `Claude Code`
  - アーキテクチャ設計: `Claude Code`

#### 7. Schedule

- **Kick-off:** `2025-07-27`
- **設計・実装完了:** `2025-07-27`
- **テスト・修正:** `2025-07-27`
- **Final Delivery:** `2025-07-27`

#### 8. Acceptance Criteria

- **機能要件:**
  - 古いJSONフォーマット（`wodicon_games`等）のファイルをインポート時に明確に拒否し、適切なエラーメッセージを表示する
  - 不正なJSON構文のファイルで詳細なエラー位置と修正提案を表示する
  - 不正なCSV形式のファイルで具体的な問題行と修正方法を表示する
  - 有効なファイルのみが正常にインポート処理される

- **技術要件:**
  - 既存のimportFromJSON()とimportFromCSV()関数が非破壊的に拡張される
  - window.errorHandlerとの統合により統一的なエラーハンドリングが実現される
  - 検証処理の実行時間が3秒以内（通常サイズファイル）

- **ユーザビリティ要件:**
  - エラーメッセージが日本語で分かりやすく表示される
  - ファイル修正のための具体的な提案が提示される
  - インポート失敗時にユーザーデータが破損しない

#### 9. Change Log

*初回作成のため変更履歴なし*

---

## Technical Notes

### 現在の問題箇所

1. **options.js:898-902** `importFromJSON()`
   - 単純な`JSON.parse()`のみで詳細検証なし
   - `chrome.storage.local.set(data)`で無検証保存

2. **dataManager.js:339-395** `importData()`
   - 古いフォーマット変換ロジックが複雑化
   - エラーハンドリングが不十分

3. **options.js:905-950** `importFromCSV()`
   - ヘッダー検証が基本的なもののみ
   - データ型・範囲チェックなし

### 検証対象フォーマット仕様

**新JSONフォーマット (v1.0.3+):**
```json
{
  "games": [
    {
      "id": "string|number",
      "title": "string",
      "rating": {
        "熱中度": "number(1-10)|null",
        "斬新さ": "number(1-10)|null", 
        "物語性": "number(1-10)|null",
        "画像音響": "number(1-10)|null",
        "遊びやすさ": "number(1-10)|null",
        "その他": "number(0-10)|null"
      },
      "is_played": "boolean",
      "created_at": "string(ISO date)",
      "updated_at": "string(ISO date)"
    }
  ],
  "settings": {},
  "metadata": {}
}
```

**CSVフォーマット:**
```csv
作品No,作品名,熱中度,斬新さ,物語性,画像音声,遊びやすさ,その他,感想
1,"作品名",8,7,9,8,7,6,"感想文"
```