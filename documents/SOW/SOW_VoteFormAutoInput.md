# SOW: 投票ページ自動入力機能

## 1. 目的

本機能は、Chrome拡張機能「ウディこん助」に保存されている作品の評価・感想データを、ウディコンの公式投票ページ上のフォームに自動で入力することを目的とします。これにより、ユーザーの二重入力の手間を省き、投票プロセスを大幅に効率化します。

## 2. 背景

ユーザーは現在、拡張機能内に評価や感想を記録した後、それらを公式の投票ページに手動でコピー＆ペーストする必要があります。この手作業は時間がかかり、入力ミスの原因にもなります。本機能は、このプロセスを自動化することで、より快適な作品応援体験を提供するために必要とされます。

## 3. スコープ

### 3.1. 対象範囲 (In-Scope)

*   **UIの追加**: 拡張機能のポップアップ画面に「投票フォームに入力」ボタンを新設します。
*   **データ連携**:
    *   ボタンクリック時、拡張機能に保存されている現在表示中の作品データ（評価6項目、感想テキスト）を読み込みます。
    *   読み込んだデータを、現在アクティブなタブで開かれている投票ページへ送信します。
*   **自動入力処理**:
    *   投票ページに読み込まれたContent Script (`content.js`) が、送信されたデータを受け取ります。
    *   作品名をキーとして、ページ内の該当作品の入力欄を特定します。
    *   特定した入力欄に、評価6項目と感想テキストを自動で設定します。
    *   該当作品の「投票する」チェックボックスを自動でONにします。

### 3.2. 対象外範囲 (Out-of-Scope)

*   フォームの自動送信（最終的な送信はユーザーが手動で行います）。
*   投票用ID (`votecode`) の入力。
*   ページ上部にある「重要度」設定（`all_1`〜`all_5`）の自動入力。
*   投票ページへの自動的な画面遷移。

## 4. 技術的分析と実装方針

### 4.1. 対象ページ分析

*   **URL**: `https://silversecond.com/WolfRPGEditor/Contest/cgi/contestVote.cgi`
*   **文字コード**: Shift_JIS
*   **フォーム構造**:
    *   ページ全体が単一の`<form>`タグで構成されています。
    *   各作品は個別の`<table>`要素で管理されています。
    *   各入力要素の`name`属性は、作品番号を基に一意に定義されています。
        *   **投票チェックボックス**: `Game_作品番号_FLAG`
        *   **評価セレクトボックス (1-6)**: `Game_作品番号_PT1` 〜 `Game_作品番号_PT6`
        *   **感想テキストエリア**: `Game_作品番号_Com`

### 4.2. 実装方針

1.  **作品のマッピング**:
    *   拡張機能から送られた作品タイトルと、投票ページ内の各`<table>`に含まれる作品タイトル（`<b>`タグ内のテキスト）を照合します。
    *   タイトルが一致した`<table>`から、その作品に対応する「作品番号」を特定します。この番号を基に入力要素の`name`属性を動的に生成します。

2.  **データ入力処理 (`content.js`)**:
    *   `document.querySelector` を使用し、生成した`name`属性を持つ要素を特定します。
    *   セレクトボックス (`<select>`) とテキストエリア (`<textarea>`) には `.value` プロパティで値を設定します。
    *   チェックボックス (`<input type="checkbox">`) には `.checked = true` を設定します。

## 5. 実装タスク

本機能は以下のフェーズで実装を進めます。

*   **Phase 1: UIコンポーネントの追加**
    *   `popup.html`: 投票フォームへの入力開始を指示するボタンを追加します。
    *   `popup.css`: 追加したボタンのスタイルを定義します。

*   **Phase 2: ポップアップのロジック更新**
    *   `js/popup.js`:
        *   新設ボタンにイベントリスナーを追加します。
        *   `dataManager.js` を介して作品データを取得し、`chrome.tabs.sendMessage` を用いて`content.js`へ送信する処理を実装します。

*   **Phase 3: Content Scriptの実装**
    *   `js/content.js`:
        *   `chrome.runtime.onMessage` でポップアップからのデータを受信します。
        *   受信したデータを基に、前述の「作品マッピング」および「データ入力処理」を実行するロジックを実装します。

## 6. リスクと懸念事項

*   **ページ構造の変更**: 投票ページのHTML構造（特に`name`属性）が変更された場合、本機能が動作しなくなる可能性があります。
*   **作品名の不一致**: 拡張機能内の作品名とページ上の作品名に僅かな差異（例: 全角/半角スペース）があった場合、マッピングに失敗する可能性があります。これに対応するため、ある程度の「あいまい一致」を許容する比較処理を検討します。
