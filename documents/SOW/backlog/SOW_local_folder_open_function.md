# SOW: ローカルフォルダオープン機能実装

---
project_name: "ローカルフォルダオープン機能実装"
status: "Todo"
owner: "Claude Code"
created_at: "2025-08-04"
updated_at: "2025-08-04"
---

- **Project Name:** `ローカルフォルダオープン機能実装`
- **Creation Date:** `2025-08-04`
- **Revision History:**
  - `v1.0 (2025-08-04): Initial draft`

## 1. Project Purpose & Background

ウディこん助Chrome拡張機能において、各作品に対応するローカルPCフォルダを直接エクスプローラで開く機能を実装する。

**現状課題:**
- ユーザーが作品ファイルを管理するためのローカルフォルダアクセスが不便
- Chrome拡張機能から直接ローカルフォルダを開く手段が限定的
- セキュリティ制約により直接的なファイルシステムアクセスが困難

**解決方針:**
Native Messaging APIを活用し、Chrome拡張機能とローカルバッチスクリプトを連携させることで、安全かつ効率的なローカルフォルダアクセス機能を提供する。

## 2. Scope of Work

### 2.1 Chrome拡張機能側の実装（責任の分離）
- **データ管理範囲の限定**
  - **ルートディレクトリパスのみ保持**（chrome.storage.local）
  - 個別フォルダパス情報は保持しない（bat側で動的生成）
- **オプション画面に追加機能解放UI追加**
  - 「追加機能を解放」ボタンとユーザー承諾確認
  - ルートフォルダ設定UI（フォルダ選択・パス入力）
  - 初期フォルダ作成実行ボタン
- **各作品詳細画面にフォルダアイコン追加**
  - 作品別フォルダアクセスボタン（📁アイコン）
  - 作品Noのみを引数として渡す処理
- **Native Messaging通信処理実装**
  - フォルダ作成用通信：`createFolders` アクション
  - フォルダオープン用通信：`openFolder` アクション
  - JSON形式での作品データ送信（標準入力経由）
  - エラーハンドリング・フォールバック処理
- **作品データ抽出・サニタイゼーション処理**
  - 全作品の「No, タイトル」データ取得
  - ファイル名用サニタイゼーション（Windows制限文字除去）
  - 長いタイトルの短縮処理（最大200文字）
- **manifest.json更新**
  - `nativeMessaging` 権限追加
  - 2つのNative Messaging ホスト定義

### 2.2 ローカルシステム側の実装（2batファイル分離）
- **Native Messaging ホスト定義ファイル作成**
  - `com.wudiconsuke.createfolders.json` - フォルダ作成用
  - `com.wudiconsuke.openfolder.json` - フォルダオープン用
  - Chrome User Dataディレクトリへの配置仕様
- **フォルダ作成用バッチスクリプト実装**
  - `create_folders.bat` 作成
  - 標準入力からJSON形式で「全作品のNo,タイトル」受信
  - `<ルートパス>\<作品No(00)>_<作品タイトル>` 形式でフォルダ作成
  - 既存フォルダチェック・冪等性保証
  - 文字エンコーディング対応（UTF-8 → SHIFT-JIS変換）
  - 作成結果のJSON形式レスポンス
- **フォルダオープン用バッチスクリプト実装**
  - `open_folder.bat` 作成
  - 標準入力から「作品No」のみ受信
  - `<ルートパス>\<作品No(00)>_*` パターンでフォルダ検索
  - エクスプローラ起動処理
  - フォルダ未存在時のエラーハンドリング
- **共通ユーティリティ**
  - ファイル名サニタイゼーション処理（PowerShell連携）
  - JSON解析・生成処理（PowerShell連携）
- **インストーラーパッケージ作成**
  - 配布用パッケージ構成（2bat + 2json + README）
  - ユーザー向け導入手順書

### 2.3 フォルダ管理システム（責任分離）
- **Chrome拡張機能の責任範囲**
  - ルートディレクトリパスのみ管理・保存
  - 作品データ（No, タイトル）の抽出・送信
- **バッチスクリプトの責任範囲**
  - フォルダ命名規則適用：`<作品No(00)>_<作品タイトル>`
  - フォルダ存在確認・作成処理
  - フォルダ検索・オープン処理
- **データフロー設計**
  - フォルダ作成：Chrome → JSON（全作品データ） → create_folders.bat
  - フォルダオープン：Chrome → 作品No → open_folder.bat → 動的フォルダ検索

## 3. Out of Scope

以下の項目は本SOWの対象外とする：
- macOS・Linux対応（Windows専用）
- ファイル内容操作・編集機能
- 他のアプリケーション連携（エクスプローラ以外）
- 自動ファイル同期・バックアップ機能
- ネットワークドライブ・クラウドストレージ対応
- 既存のローカルフォルダ連携機能との統合（既存機能は廃止予定）

## 4. Deliverables

### 4.1 Chrome拡張機能関連
- **更新ファイル:**
  - `/wodicon_helper/manifest.json` - nativeMessaging権限、2つのホスト定義追加
  - `/wodicon_helper/js/options.js` - 追加機能解放UI、ルートフォルダ設定、フォルダ作成実行
  - `/wodicon_helper/js/navigation.js` - 各作品のフォルダアイコン追加（作品No渡し）
  - `/wodicon_helper/js/folderManager.js` - 新規作成（責任分離対応）
    - 作品データ抽出・サニタイゼーション
    - 2つのNative Messaging通信（createFolders, openFolder）
    - ルートパス管理のみ
  - `/wodicon_helper/options.html` - 追加機能設定UI、フォルダ作成ボタン
  - `/wodicon_helper/css/popup.css` - フォルダアイコンスタイル

### 4.2 ローカルシステム関連
- **新規ファイル:**
  - `/installer/create_folders.bat` - フォルダ一括作成用バッチスクリプト
  - `/installer/open_folder.bat` - フォルダオープン用バッチスクリプト
  - `/installer/com.wudiconsuke.createfolders.json` - フォルダ作成用Native Messaging定義
  - `/installer/com.wudiconsuke.openfolder.json` - フォルダオープン用Native Messaging定義
  - `/installer/folder_utils.ps1` - PowerShell共通ユーティリティ（JSON処理・サニタイゼーション）
  - `/installer/README.txt` - ユーザー向け導入手順書（2batファイル対応）
  - `/installer/install.bat` - 自動配置スクリプト（2ファイル対応）

### 4.3 ドキュメント関連
- **機能説明書**
  - 追加機能の使用方法説明
  - トラブルシューティングガイド
  - セキュリティ注意事項

## 5. Assumptions & Constraints

### 5.1 Assumptions
- ユーザーがWindows環境を使用している
- Chrome拡張機能の権限追加をユーザーが承諾する
- ローカルPCへのファイル配置をユーザーが実行できる
- エクスプローラでのフォルダアクセスが主要な用途である

### 5.2 Constraints
- **セキュリティ制約**: Chrome拡張機能のセキュリティポリシーに準拠
- **権限制約**: 最小権限原則に従った実装（nativeMessagingのみ追加）
- **プラットフォーム制約**: Windows専用機能として実装
- **配布制約**: バッチファイル配布時のセキュリティ警告対応が必要

## 6. Team & Roles

- **開発担当:** Claude Code
- **テスト担当:** ユーザー
- **導入サポート担当:** ユーザー（自己導入）

## 7. Schedule

- **要件確認完了:** 2025-08-04
- **Chrome拡張機能実装完了:** 2025-08-04
- **Native Messaging実装完了:** 2025-08-04
- **インストーラーパッケージ作成完了:** 2025-08-04
- **テスト・最終確認完了:** 2025-08-04

## 8. Acceptance Criteria

### 8.1 Chrome拡張機能（責任分離対応）
- [ ] オプション画面に「追加機能を解放」UI実装
- [ ] ルートフォルダ設定UI実装（パスのみ管理）
- [ ] 初期フォルダ作成実行ボタン実装
- [ ] 各作品詳細画面にフォルダアイコン表示（作品No渡し）
- [ ] 2つのNative Messaging通信が正常動作
  - createFolders: JSON形式で全作品データ送信
  - openFolder: 作品Noのみ送信
- [ ] 作品データ抽出・サニタイゼーション処理実装
- [ ] エラーハンドリングが適切に実装

### 8.2 ローカルシステム（2batファイル対応）
- [ ] 2つのNative Messaging ホスト定義ファイル作成・配置
- [ ] フォルダ作成用バッチスクリプト実装
  - JSON形式での全作品データ受信
  - `<作品No(00)>_<作品タイトル>` 形式でフォルダ作成
  - 既存フォルダチェック・冪等性保証
- [ ] フォルダオープン用バッチスクリプト実装
  - 作品Noのみ受信
  - 動的フォルダ検索・エクスプローラ起動
- [ ] 文字エンコーディング対応（UTF-8 ↔ SHIFT-JIS）
- [ ] 配布パッケージ完成（2bat + 2json + utils + README）

### 8.3 統合テスト
- [ ] Chrome拡張からバッチスクリプト呼び出しが成功
- [ ] 作品別フォルダが正しく開かれる
- [ ] エラー時の適切なメッセージ表示
- [ ] 権限エラー・ファイル未配置時の適切な対応

### 8.4 セキュリティ・安全性
- [ ] 最小権限での実装完了
- [ ] パス検証・サニタイゼーション実装
- [ ] セキュリティ警告対応ドキュメント完備
- [ ] ユーザー承諾プロセスの実装

## 9. Change Log

*初版のため変更履歴なし*

---

**備考**
- 本機能はWindows専用の上級者向け機能として位置づけ
- セキュリティリスクを十分説明した上でのオプトイン方式採用
- 将来的にはWeb File System Access APIへの移行を検討
- Chrome Web Store審査への影響を考慮した慎重な実装が必要

**重要な技術的制約・対応策**
- **データ送信制限**: Native Messagingメッセージサイズ制限（1MB）内で80作品データ（約4KB）は問題なし
- **ファイル名制限**: Windows制限文字（< > : " | ? * \ /）のサニタイゼーション処理必須
- **コマンドライン制限**: 引数制限（8192文字）回避のため、JSON + 標準入力方式を採用
- **文字エンコーディング**: UTF-8（Chrome） ↔ SHIFT-JIS（Windows）変換対応が必要
- **冪等性保証**: 既存フォルダチェック・部分失敗時の継続処理実装
- **動的フォルダ検索**: 作品Noのみからフォルダ名を推定するパターンマッチング処理
- **PowerShell依存**: JSON処理・文字列操作でPowerShell連携が必要（Windows標準装備）

**責任分離による設計メリット**
- Chrome拡張機能の軽量化（ルートパスのみ管理）
- バッチ処理の独立性向上（フォルダ管理ロジック分離）
- メンテナンス性向上（各コンポーネントの責任明確化）
- セキュリティリスク軽減（Chrome側での個別パス情報保持回避）