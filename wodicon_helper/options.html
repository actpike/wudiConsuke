<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ã‚¦ãƒ‡ã‚£ã“ã‚“åŠ© - è¨­å®š</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
      background: #a3a3e5;
      color: #333;
    }
    
    .header {
      background: #667eea;
      color: white;
      padding: 20px;
      border-radius: 10px;
      margin-bottom: 20px;
      text-align: center;
    }
    
    .section {
      background: white;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    h1 { margin: 0; font-size: 24px; }
    h2 { margin-top: 0; color: #667eea; border-bottom: 2px solid #667eea; padding-bottom: 10px; }
    
    .setting-item {
      margin-bottom: 15px;
      padding: 10px;
      border: 1px solid #eee;
      border-radius: 5px;
    }
    
    label {
      display: block;
      font-weight: bold;
      margin-bottom: 5px;
    }
    
    input, select, textarea {
      width: 100%;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
    }
    
    button {
      background: #667eea;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
      margin: 5px;
      transition: background 0.3s;
    }
    
    button:hover { background: #5a6fd8; }
    button.secondary { background: #6c757d; }
    button.danger { background: #dc3545; }
    
    .file-input { margin: 10px 0; }
    .status { padding: 10px; border-radius: 4px; margin: 10px 0; }
    .status.success { background: #d4edda; color: #155724; }
    .status.error { background: #f8d7da; color: #721c24; }
    .status.info { background: #d1ecf1; color: #0c5460; }
  </style>
</head>
<body>
  <div class="header">
    <h1>ğŸŒŠ ã‚¦ãƒ‡ã‚£ã“ã‚“åŠ© - è¨­å®š</h1>
    <p>Chromeæ‹¡å¼µæ©Ÿèƒ½ã®è¨­å®šã¨ãƒ‡ãƒ¼ã‚¿ç®¡ç†</p>
  </div>

  <div class="section">
    <h2>ğŸ“Š ãƒ‡ãƒ¼ã‚¿çµ±è¨ˆ</h2>
    <div id="statistics">
      <p>èª­ã¿è¾¼ã¿ä¸­...</p>
    </div>
  </div>

  <div class="section">
    <h2>ğŸ’¾ ãƒ‡ãƒ¼ã‚¿ç®¡ç†</h2>
    <div class="setting-item">
      <h3>ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</h3>
      <p>å…¨ã¦ã®ä½œå“ãƒ‡ãƒ¼ã‚¿ã¨è¨­å®šã‚’JSONãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦ä¿å­˜ã§ãã¾ã™ã€‚</p>
      <button id="export-btn">ğŸ“¤ ãƒ‡ãƒ¼ã‚¿ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
    </div>
    
    <div class="setting-item">
      <h3>ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</h3>
      <p>ä»¥å‰ã«ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ãŸãƒ‡ãƒ¼ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚€ã“ã¨ãŒã§ãã¾ã™ã€‚</p>
      <div class="file-input">
        <input type="file" id="import-file" accept=".json">
        <button id="import-btn">ğŸ“¥ ãƒ‡ãƒ¼ã‚¿ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</button>
      </div>
    </div>
    
    <div id="import-export-status"></div>
  </div>

  <div class="section">
    <h2>ğŸ“¡ Webç›£è¦–è¨­å®š</h2>
    <div class="setting-item">
      <label for="monitoring-mode">ç›£è¦–ãƒ¢ãƒ¼ãƒ‰:</label>
      <select id="monitoring-mode">
        <option value="disabled">ç„¡åŠ¹</option>
        <option value="all">å…¨ä½œå“</option>
        <option value="selected">æ³¨ç›®ä½œå“ã®ã¿</option>
      </select>
      <small>é¸æŠã—ãŸç›£è¦–ãƒ¢ãƒ¼ãƒ‰ã«åŸºã¥ã„ã¦è‡ªå‹•ç›£è¦–ã‚’å®Ÿè¡Œã—ã¾ã™</small>
    </div>
    
    <div class="setting-item">
      <label for="monitoring-interval">ç›£è¦–é–“éš”:</label>
      <select id="monitoring-interval">
        <option value="0">ç›£è¦–ã—ãªã„</option>
        <option value="15">15åˆ†</option>
        <option value="30">30åˆ†</option>
        <option value="60">1æ™‚é–“</option>
        <option value="120">2æ™‚é–“</option>
        <option value="240">4æ™‚é–“</option>
      </select>
      <small>çŸ­ã„é–“éš”ã»ã©ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ€§ãŒå‘ä¸Šã—ã¾ã™ãŒã€ãƒªã‚½ãƒ¼ã‚¹ã‚’æ¶ˆè²»ã—ã¾ã™</small>
    </div>
    
    <div class="setting-item">
      <label>
        <input type="checkbox" id="monitor-on-startup"> 
        ãƒ–ãƒ©ã‚¦ã‚¶èµ·å‹•æ™‚ã«ãƒã‚§ãƒƒã‚¯
      </label>
      <small>ãƒ–ãƒ©ã‚¦ã‚¶èµ·å‹•æ™‚ã«ä¸€åº¦ç›£è¦–ã‚’å®Ÿè¡Œã—ã¾ã™</small>
    </div>
    
    <div class="setting-item">
      <label>æœ€çµ‚ç›£è¦–æ™‚åˆ»:</label>
      <span id="last-monitor-time">æœªå®Ÿè¡Œ</span>
      <button id="manual-monitor-now" class="secondary">ä»Šã™ãç›£è¦–å®Ÿè¡Œ</button>
    </div>
  </div>

  <div class="section">
    <h2>ğŸ”” é€šçŸ¥è¨­å®š</h2>
    <div class="setting-item">
      <label>
        <input type="checkbox" id="enable-notifications"> 
        Chromeé€šçŸ¥ã‚’æœ‰åŠ¹ã«ã™ã‚‹
      </label>
    </div>
    
    <div class="setting-item">
      <label>
        <input type="checkbox" id="notify-new-works"> 
        æ–°è¦ä½œå“ã‚’é€šçŸ¥
      </label>
    </div>
    
    <div class="setting-item">
      <label>
        <input type="checkbox" id="notify-updated-works"> 
        æ›´æ–°ä½œå“ã‚’é€šçŸ¥
      </label>
    </div>
    
    <div class="setting-item">
      <label for="max-notifications">æœ€å¤§é€šçŸ¥ä»¶æ•°:</label>
      <select id="max-notifications">
        <option value="1">1ä»¶</option>
        <option value="3">3ä»¶</option>
        <option value="5">5ä»¶</option>
        <option value="10">10ä»¶</option>
      </select>
      <small>ä¸€åº¦ã«è¡¨ç¤ºã™ã‚‹é€šçŸ¥ã®æœ€å¤§æ•°ã§ã™</small>
    </div>
    
    <div class="setting-item">
      <button id="test-notification" class="secondary">ğŸ”” ãƒ†ã‚¹ãƒˆé€šçŸ¥é€ä¿¡</button>
      <small>è¨­å®šç¢ºèªç”¨ã®ãƒ†ã‚¹ãƒˆé€šçŸ¥ã‚’é€ä¿¡ã—ã¾ã™</small>
    </div>
  </div>

  <div class="section">
    <h2>ğŸ“Š ç›£è¦–å±¥æ­´ãƒ»çµ±è¨ˆ</h2>
    <div class="setting-item">
      <h3>æœ€è¿‘ã®ç›£è¦–å±¥æ­´</h3>
      <div id="monitor-history">
        <p>èª­ã¿è¾¼ã¿ä¸­...</p>
      </div>
    </div>
    
    <div class="setting-item">
      <h3>çµ±è¨ˆæƒ…å ±</h3>
      <div id="monitor-statistics">
        <p>èª­ã¿è¾¼ã¿ä¸­...</p>
      </div>
    </div>
    
    <div class="setting-item">
      <h3>æ›´æ–°ãƒãƒ¼ã‚«ãƒ¼ç®¡ç†</h3>
      <div id="update-markers">
        <p>èª­ã¿è¾¼ã¿ä¸­...</p>
      </div>
      <button id="clear-all-markers" class="secondary">å…¨ãƒãƒ¼ã‚«ãƒ¼ã‚¯ãƒªã‚¢</button>
    </div>
  </div>

  <div class="section">
    <h2>ğŸ”§ ãã®ä»–è¨­å®š</h2>
    <div class="setting-item">
      <label>
        <input type="checkbox" id="auto-backup"> 
        è‡ªå‹•ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ï¼ˆå°†æ¥æ©Ÿèƒ½ï¼‰
      </label>
    </div>
  </div>

  <div class="section">
    <h2>âš ï¸ ãƒ‡ãƒ¼ã‚¿å‰Šé™¤</h2>
    <p><strong>æ³¨æ„:</strong> ã“ã®æ“ä½œã¯å…ƒã«æˆ»ã™ã“ã¨ãŒã§ãã¾ã›ã‚“ã€‚</p>
    <button id="clear-data-btn" class="danger">ğŸ—‘ï¸ å…¨ãƒ‡ãƒ¼ã‚¿å‰Šé™¤</button>
    <button id="reset-settings-btn" class="secondary">ğŸ”„ è¨­å®šãƒªã‚»ãƒƒãƒˆ</button>
  </div>

  <div class="section">
    <h2>â„¹ï¸ æƒ…å ±</h2>
    <p><strong>ãƒãƒ¼ã‚¸ãƒ§ãƒ³:</strong> <span id="version">1.0.0</span></p>
    <p><strong>æœ€çµ‚æ›´æ–°:</strong> <span id="last-update">-</span></p>
    <p><strong>ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ä½¿ç”¨é‡:</strong> <span id="storage-usage">-</span></p>
  </div>

  <script>
    // ã‚ªãƒ—ã‚·ãƒ§ãƒ³ãƒšãƒ¼ã‚¸ã‚¹ã‚¯ãƒªãƒ—ãƒˆ
    document.addEventListener('DOMContentLoaded', async () => {
      await loadStatistics();
      await loadSettings();
      setupEventListeners();
    });

    async function loadStatistics() {
      try {
        const response = await chrome.runtime.sendMessage({ action: 'getStorageUsage' });
        if (response.success) {
          const usage = response.usage;
          document.getElementById('storage-usage').textContent = 
            `${usage.usedKB} KB / ${Math.round(usage.total / 1024)} KB (${usage.percentage}%)`;
        }

        // ã‚²ãƒ¼ãƒ çµ±è¨ˆã‚’å–å¾—ï¼ˆdataManagerçµŒç”±ï¼‰
        chrome.tabs.query({ active: true, currentWindow: true }, (tabs) => {
          chrome.scripting.executeScript({
            target: { tabId: tabs[0].id },
            func: async () => {
              // çµ±è¨ˆæƒ…å ±ã‚’å–å¾—ã™ã‚‹å‡¦ç†
              return { total: 6, played: 3 }; // ã‚µãƒ³ãƒ—ãƒ«
            }
          }).then((results) => {
            if (results && results[0]) {
              const stats = results[0].result;
              document.getElementById('statistics').innerHTML = `
                <p>ğŸ“Š ç·ä½œå“æ•°: ${stats.total || 6}ä»¶</p>
                <p>âœ… è©•ä¾¡æ¸ˆã¿: ${stats.played || 3}ä»¶</p>
                <p>â³ æœªè©•ä¾¡: ${(stats.total || 6) - (stats.played || 3)}ä»¶</p>
              `;
            }
          }).catch(() => {
            document.getElementById('statistics').innerHTML = `
              <p>ğŸ“Š ç·ä½œå“æ•°: 6ä»¶</p>
              <p>âœ… è©•ä¾¡æ¸ˆã¿: 3ä»¶</p>
              <p>â³ æœªè©•ä¾¡: 3ä»¶</p>
            `;
          });
        });

      } catch (error) {
        console.error('çµ±è¨ˆèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
      }
    }

    async function loadSettings() {
      try {
        // åŸºæœ¬è¨­å®š
        const result = await chrome.storage.local.get(['wodicon_settings', 'web_monitor_settings', 'update_manager_settings']);
        const settings = result.wodicon_settings || {};
        const webMonitorSettings = result.web_monitor_settings || {};
        const updateSettings = result.update_manager_settings || {};

        // åŸºæœ¬è¨­å®š
        document.getElementById('enable-notifications').checked = settings.enable_notifications !== false;
        document.getElementById('auto-backup').checked = settings.auto_backup_enabled || false;

        // Webç›£è¦–è¨­å®š
        document.getElementById('monitoring-mode').value = webMonitorSettings.mode || 'disabled';
        document.getElementById('monitoring-interval').value = webMonitorSettings.interval || 30;
        document.getElementById('monitor-on-startup').checked = webMonitorSettings.checkOnStartup || false;

        // é€šçŸ¥è¨­å®š
        document.getElementById('notify-new-works').checked = updateSettings.showNewWorks !== false;
        document.getElementById('notify-updated-works').checked = updateSettings.showUpdatedWorks !== false;
        document.getElementById('max-notifications').value = updateSettings.maxNotifications || 5;

        // æœ€çµ‚ç›£è¦–æ™‚åˆ»ã®è¡¨ç¤º
        updateLastMonitorTime(webMonitorSettings.lastCheckTime);

        // ç›£è¦–å±¥æ­´ãƒ»çµ±è¨ˆã®èª­ã¿è¾¼ã¿
        await loadMonitoringData();

      } catch (error) {
        console.error('è¨­å®šèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
      }
    }

    function setupEventListeners() {
      // ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
      document.getElementById('export-btn').addEventListener('click', async () => {
        try {
          const result = await chrome.storage.local.get();
          const exportData = {
            ...result,
            export_timestamp: new Date().toISOString(),
            version: "1.0.0"
          };

          const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `wodicon_data_${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.json`;
          a.click();

          showStatus('success', 'âœ… ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆå®Œäº†');
        } catch (error) {
          showStatus('error', 'âŒ ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆå¤±æ•—: ' + error.message);
        }
      });

      // ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
      document.getElementById('import-btn').addEventListener('click', () => {
        const file = document.getElementById('import-file').files[0];
        if (!file) {
          showStatus('error', 'âŒ ãƒ•ã‚¡ã‚¤ãƒ«ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“');
          return;
        }

        const reader = new FileReader();
        reader.onload = async (e) => {
          try {
            const data = JSON.parse(e.target.result);
            await chrome.storage.local.set(data);
            showStatus('success', 'âœ… ã‚¤ãƒ³ãƒãƒ¼ãƒˆå®Œäº†');
            setTimeout(() => location.reload(), 1000);
          } catch (error) {
            showStatus('error', 'âŒ ã‚¤ãƒ³ãƒãƒ¼ãƒˆå¤±æ•—: ' + error.message);
          }
        };
        reader.readAsText(file);
      });

      // å…¨ãƒ‡ãƒ¼ã‚¿å‰Šé™¤
      document.getElementById('clear-data-btn').addEventListener('click', async () => {
        if (confirm('æœ¬å½“ã«å…¨ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å…ƒã«æˆ»ã›ã¾ã›ã‚“ã€‚')) {
          try {
            await chrome.storage.local.clear();
            showStatus('success', 'âœ… å…¨ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
            setTimeout(() => location.reload(), 1000);
          } catch (error) {
            showStatus('error', 'âŒ å‰Šé™¤å¤±æ•—: ' + error.message);
          }
        }
      });

      // Webç›£è¦–è¨­å®šã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
      document.getElementById('manual-monitor-now').addEventListener('click', performManualMonitoring);
      document.getElementById('test-notification').addEventListener('click', sendTestNotification);
      document.getElementById('clear-all-markers').addEventListener('click', clearAllMarkers);

      // è¨­å®šå¤‰æ›´æ™‚ã®è‡ªå‹•ä¿å­˜
      ['enable-notifications', 'auto-backup', 'monitoring-mode', 'monitoring-interval', 
       'monitor-on-startup', 'notify-new-works', 'notify-updated-works', 'max-notifications'].forEach(id => {
        document.getElementById(id).addEventListener('change', saveSettings);
      });
    }

    async function saveSettings() {
      try {
        // åŸºæœ¬è¨­å®š
        const settings = {
          enable_notifications: document.getElementById('enable-notifications').checked,
          auto_backup_enabled: document.getElementById('auto-backup').checked
        };

        // Webç›£è¦–è¨­å®š
        const webMonitorSettings = {
          mode: document.getElementById('monitoring-mode').value,
          interval: parseInt(document.getElementById('monitoring-interval').value),
          checkOnStartup: document.getElementById('monitor-on-startup').checked,
          lastCheckTime: null // ä¿æŒã•ã‚Œã‚‹å€¤
        };

        // é€šçŸ¥è¨­å®š
        const updateManagerSettings = {
          enabled: document.getElementById('enable-notifications').checked,
          showNewWorks: document.getElementById('notify-new-works').checked,
          showUpdatedWorks: document.getElementById('notify-updated-works').checked,
          maxNotifications: parseInt(document.getElementById('max-notifications').value),
          soundEnabled: false
        };

        await chrome.storage.local.set({ 
          wodicon_settings: settings,
          web_monitor_settings: webMonitorSettings,
          update_manager_settings: updateManagerSettings
        });

        // Background Scriptã«ç›£è¦–è¨­å®šå¤‰æ›´ã‚’é€šçŸ¥
        try {
          await chrome.runtime.sendMessage({
            action: webMonitorSettings.mode !== 'disabled' && webMonitorSettings.interval > 0 ? 'start_web_monitoring' : 'stop_web_monitoring',
            settings: webMonitorSettings
          });
        } catch (bgError) {
          console.log('Background Scripté€šçŸ¥ã‚¹ã‚­ãƒƒãƒ—:', bgError.message);
        }

        showStatus('success', 'âœ… è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸ', 2000);
      } catch (error) {
        showStatus('error', 'âŒ è¨­å®šä¿å­˜å¤±æ•—: ' + error.message);
      }
    }

    function showStatus(type, message, duration = 3000) {
      const statusDiv = document.getElementById('import-export-status');
      statusDiv.className = `status ${type}`;
      statusDiv.textContent = message;
      
      setTimeout(() => {
        statusDiv.textContent = '';
        statusDiv.className = 'status';
      }, duration);
    }

    // Webç›£è¦–é–¢é€£æ©Ÿèƒ½
    async function performManualMonitoring() {
      const button = document.getElementById('manual-monitor-now');
      try {
        button.disabled = true;
        button.textContent = 'ç›£è¦–å®Ÿè¡Œä¸­...';
        
        // Background Scriptã«æ‰‹å‹•ç›£è¦–ã‚’è¦æ±‚
        const response = await chrome.runtime.sendMessage({ action: 'perform_manual_monitoring' });
        
        if (response && response.success) {
          showStatus('success', 'âœ… ç›£è¦–å®Œäº†: ' + (response.result?.summary || 'çµæœãªã—'));
          updateLastMonitorTime(new Date().toISOString());
          await loadMonitoringData(); // å±¥æ­´ã‚’æ›´æ–°
        } else {
          showStatus('error', 'âŒ ç›£è¦–å¤±æ•—: ' + (response?.error || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'));
        }
      } catch (error) {
        showStatus('error', 'âŒ ç›£è¦–ã‚¨ãƒ©ãƒ¼: ' + error.message);
      } finally {
        button.disabled = false;
        button.textContent = 'ä»Šã™ãç›£è¦–å®Ÿè¡Œ';
      }
    }

    async function sendTestNotification() {
      try {
        await chrome.notifications.create('test_notification', {
          type: 'basic',
          iconUrl: '../icons/icon48.png',
          title: 'ğŸ”” ãƒ†ã‚¹ãƒˆé€šçŸ¥',
          message: 'Webç›£è¦–ã®é€šçŸ¥è¨­å®šãŒæ­£å¸¸ã«å‹•ä½œã—ã¦ã„ã¾ã™ã€‚\næ–°è¦ï¼š1ä»¶ã€æ›´æ–°ï¼š1ä»¶ï¼ˆNo.02_è¬è§£ãã‚«ãƒ•ã‚§äº‹ä»¶ç°¿ ä»–ï¼‰',
          priority: 1
        });
        showStatus('success', 'âœ… ãƒ†ã‚¹ãƒˆé€šçŸ¥ã‚’é€ä¿¡ã—ã¾ã—ãŸ');
      } catch (error) {
        showStatus('error', 'âŒ é€šçŸ¥é€ä¿¡å¤±æ•—: ' + error.message);
      }
    }

    async function clearAllMarkers() {
      if (confirm('å…¨ã¦ã®æ›´æ–°ãƒãƒ¼ã‚«ãƒ¼ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã™ã‹ï¼Ÿ')) {
        try {
          await chrome.storage.local.remove('update_markers');
          showStatus('success', 'âœ… å…¨ãƒãƒ¼ã‚«ãƒ¼ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ');
          await loadMonitoringData(); // è¡¨ç¤ºã‚’æ›´æ–°
        } catch (error) {
          showStatus('error', 'âŒ ãƒãƒ¼ã‚«ãƒ¼ã‚¯ãƒªã‚¢å¤±æ•—: ' + error.message);
        }
      }
    }

    function updateLastMonitorTime(timestamp) {
      const timeSpan = document.getElementById('last-monitor-time');
      if (timestamp) {
        timeSpan.textContent = new Date(timestamp).toLocaleString();
      } else {
        timeSpan.textContent = 'æœªå®Ÿè¡Œ';
      }
    }

    async function loadMonitoringData() {
      try {
        // ç›£è¦–å±¥æ­´
        const historyResult = await chrome.storage.local.get('monitor_history');
        const history = historyResult.monitor_history || [];
        
        const historyDiv = document.getElementById('monitor-history');
        if (history.length === 0) {
          historyDiv.innerHTML = '<p>ç›£è¦–å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“</p>';
        } else {
          historyDiv.innerHTML = history.slice(0, 10).map(h => 
            `<div class="history-item">
              <strong>${new Date(h.timestamp).toLocaleString()}</strong>: 
              æ–°è¦${h.newWorks || 0}ä»¶, æ›´æ–°${h.updatedWorks || 0}ä»¶
              ${h.error ? ` <span style="color: red;">(ã‚¨ãƒ©ãƒ¼)</span>` : ''}
            </div>`
          ).join('');
        }

        // çµ±è¨ˆæƒ…å ±
        const statsDiv = document.getElementById('monitor-statistics');
        const totalChecks = history.length;
        const totalNew = history.reduce((sum, h) => sum + (h.newWorks || 0), 0);
        const totalUpdated = history.reduce((sum, h) => sum + (h.updatedWorks || 0), 0);
        const errorCount = history.filter(h => h.error).length;
        
        statsDiv.innerHTML = `
          <p><strong>ç·ç›£è¦–å›æ•°:</strong> ${totalChecks}å›</p>
          <p><strong>æ¤œå‡ºæ–°è¦ä½œå“:</strong> ${totalNew}ä»¶</p>
          <p><strong>æ¤œå‡ºæ›´æ–°ä½œå“:</strong> ${totalUpdated}ä»¶</p>
          <p><strong>ã‚¨ãƒ©ãƒ¼å›æ•°:</strong> ${errorCount}å›</p>
        `;

        // æ›´æ–°ãƒãƒ¼ã‚«ãƒ¼
        const markersResult = await chrome.storage.local.get('update_markers');
        const markers = markersResult.update_markers || {};
        
        const markersDiv = document.getElementById('update-markers');
        const markerKeys = Object.keys(markers);
        if (markerKeys.length === 0) {
          markersDiv.innerHTML = '<p>æœªç¢ºèªã®æ›´æ–°ã¯ã‚ã‚Šã¾ã›ã‚“</p>';
        } else {
          markersDiv.innerHTML = markerKeys.map(workNo => {
            const marker = markers[workNo];
            return `<div class="marker-item">
              <strong>No.${workNo}</strong>: ${marker.type} 
              <span style="font-size: 0.9em; color: #666;">(${new Date(marker.timestamp).toLocaleString()})</span>
            </div>`;
          }).join('');
        }

      } catch (error) {
        console.error('ç›£è¦–ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
      }
    }

    // ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±è¡¨ç¤º
    document.getElementById('version').textContent = chrome.runtime.getManifest().version;
  </script>
</body>
</html>