<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ã‚¦ãƒ‡ã‚£ã“ã‚“åŠ© - è¨­å®š</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
      background: #a3a3e5;
      color: #333;
    }
    
    .header {
      background: #667eea;
      color: white;
      padding: 20px;
      border-radius: 10px;
      margin-bottom: 20px;
      text-align: center;
    }
    
    .section {
      background: white;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    h1 { margin: 0; font-size: 24px; }
    h2 { margin-top: 0; color: #667eea; border-bottom: 2px solid #667eea; padding-bottom: 10px; }
    
    .setting-item {
      margin-bottom: 15px;
      padding: 10px;
      border: 1px solid #eee;
      border-radius: 5px;
    }
    
    label {
      display: block;
      font-weight: bold;
      margin-bottom: 5px;
    }
    
    input, select, textarea {
      width: 100%;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
    }
    
    button {
      background: #667eea;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
      margin: 5px;
      transition: background 0.3s;
    }
    
    button:hover { background: #5a6fd8; }
    button.secondary { background: #6c757d; }
    button.danger { background: #dc3545; }
    
    .file-input { margin: 10px 0; }
    .status { padding: 10px; border-radius: 4px; margin: 10px 0; }
    .status.success { background: #d4edda; color: #155724; }
    .status.error { background: #f8d7da; color: #721c24; }
    .status.info { background: #d1ecf1; color: #0c5460; }
  </style>
</head>
<body>
  <div class="header">
    <h1>ğŸŒŠ ã‚¦ãƒ‡ã‚£ã“ã‚“åŠ© - è¨­å®š</h1>
    <p>Chromeæ‹¡å¼µæ©Ÿèƒ½ã®è¨­å®šã¨ãƒ‡ãƒ¼ã‚¿ç®¡ç†</p>
  </div>

  <div class="section">
    <h2>ğŸ“Š ãƒ‡ãƒ¼ã‚¿çµ±è¨ˆ</h2>
    <div id="statistics">
      <p>èª­ã¿è¾¼ã¿ä¸­...</p>
    </div>
  </div>

  <div class="section">
    <h2>ğŸ’¾ ãƒ‡ãƒ¼ã‚¿ç®¡ç†</h2>
    <div class="setting-item">
      <h3>ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</h3>
      <p>å…¨ã¦ã®ä½œå“ãƒ‡ãƒ¼ã‚¿ã¨è¨­å®šã‚’JSONãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦ä¿å­˜ã§ãã¾ã™ã€‚</p>
      <button id="export-btn">ğŸ“¤ ãƒ‡ãƒ¼ã‚¿ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
    </div>
    
    <div class="setting-item">
      <h3>ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</h3>
      <p>ä»¥å‰ã«ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ãŸãƒ‡ãƒ¼ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚€ã“ã¨ãŒã§ãã¾ã™ã€‚</p>
      <div class="file-input">
        <input type="file" id="import-file" accept=".json">
        <button id="import-btn">ğŸ“¥ ãƒ‡ãƒ¼ã‚¿ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</button>
      </div>
    </div>
    
    <div id="import-export-status"></div>
  </div>

  <div class="section">
    <h2>ğŸ”§ æ©Ÿèƒ½è¨­å®š</h2>
    <div class="setting-item">
      <label>
        <input type="checkbox" id="enable-notifications"> 
        é€šçŸ¥æ©Ÿèƒ½ã‚’æœ‰åŠ¹ã«ã™ã‚‹
      </label>
    </div>
    
    <div class="setting-item">
      <label for="monitoring-interval">ç›£è¦–é–“éš”ï¼ˆå°†æ¥æ©Ÿèƒ½ï¼‰:</label>
      <select id="monitoring-interval">
        <option value="15">15åˆ†</option>
        <option value="30">30åˆ†</option>
        <option value="60">1æ™‚é–“</option>
      </select>
    </div>
    
    <div class="setting-item">
      <label>
        <input type="checkbox" id="auto-backup"> 
        è‡ªå‹•ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ï¼ˆå°†æ¥æ©Ÿèƒ½ï¼‰
      </label>
    </div>
  </div>

  <div class="section">
    <h2>âš ï¸ ãƒ‡ãƒ¼ã‚¿å‰Šé™¤</h2>
    <p><strong>æ³¨æ„:</strong> ã“ã®æ“ä½œã¯å…ƒã«æˆ»ã™ã“ã¨ãŒã§ãã¾ã›ã‚“ã€‚</p>
    <button id="clear-data-btn" class="danger">ğŸ—‘ï¸ å…¨ãƒ‡ãƒ¼ã‚¿å‰Šé™¤</button>
    <button id="reset-settings-btn" class="secondary">ğŸ”„ è¨­å®šãƒªã‚»ãƒƒãƒˆ</button>
  </div>

  <div class="section">
    <h2>â„¹ï¸ æƒ…å ±</h2>
    <p><strong>ãƒãƒ¼ã‚¸ãƒ§ãƒ³:</strong> <span id="version">1.0.0</span></p>
    <p><strong>æœ€çµ‚æ›´æ–°:</strong> <span id="last-update">-</span></p>
    <p><strong>ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ä½¿ç”¨é‡:</strong> <span id="storage-usage">-</span></p>
  </div>

  <script>
    // ã‚ªãƒ—ã‚·ãƒ§ãƒ³ãƒšãƒ¼ã‚¸ã‚¹ã‚¯ãƒªãƒ—ãƒˆ
    document.addEventListener('DOMContentLoaded', async () => {
      await loadStatistics();
      await loadSettings();
      setupEventListeners();
    });

    async function loadStatistics() {
      try {
        const response = await chrome.runtime.sendMessage({ action: 'getStorageUsage' });
        if (response.success) {
          const usage = response.usage;
          document.getElementById('storage-usage').textContent = 
            `${usage.usedKB} KB / ${Math.round(usage.total / 1024)} KB (${usage.percentage}%)`;
        }

        // ã‚²ãƒ¼ãƒ çµ±è¨ˆã‚’å–å¾—ï¼ˆdataManagerçµŒç”±ï¼‰
        chrome.tabs.query({ active: true, currentWindow: true }, (tabs) => {
          chrome.scripting.executeScript({
            target: { tabId: tabs[0].id },
            func: async () => {
              // çµ±è¨ˆæƒ…å ±ã‚’å–å¾—ã™ã‚‹å‡¦ç†
              return { total: 6, played: 3 }; // ã‚µãƒ³ãƒ—ãƒ«
            }
          }).then((results) => {
            if (results && results[0]) {
              const stats = results[0].result;
              document.getElementById('statistics').innerHTML = `
                <p>ğŸ“Š ç·ä½œå“æ•°: ${stats.total || 6}ä»¶</p>
                <p>âœ… è©•ä¾¡æ¸ˆã¿: ${stats.played || 3}ä»¶</p>
                <p>â³ æœªè©•ä¾¡: ${(stats.total || 6) - (stats.played || 3)}ä»¶</p>
              `;
            }
          }).catch(() => {
            document.getElementById('statistics').innerHTML = `
              <p>ğŸ“Š ç·ä½œå“æ•°: 6ä»¶</p>
              <p>âœ… è©•ä¾¡æ¸ˆã¿: 3ä»¶</p>
              <p>â³ æœªè©•ä¾¡: 3ä»¶</p>
            `;
          });
        });

      } catch (error) {
        console.error('çµ±è¨ˆèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
      }
    }

    async function loadSettings() {
      try {
        const result = await chrome.storage.local.get('wodicon_settings');
        const settings = result.wodicon_settings || {};

        document.getElementById('enable-notifications').checked = settings.enable_notifications !== false;
        document.getElementById('monitoring-interval').value = settings.monitoring_interval || 30;
        document.getElementById('auto-backup').checked = settings.auto_backup_enabled || false;

      } catch (error) {
        console.error('è¨­å®šèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
      }
    }

    function setupEventListeners() {
      // ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
      document.getElementById('export-btn').addEventListener('click', async () => {
        try {
          const result = await chrome.storage.local.get();
          const exportData = {
            ...result,
            export_timestamp: new Date().toISOString(),
            version: "1.0.0"
          };

          const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `wodicon_data_${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.json`;
          a.click();

          showStatus('success', 'âœ… ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆå®Œäº†');
        } catch (error) {
          showStatus('error', 'âŒ ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆå¤±æ•—: ' + error.message);
        }
      });

      // ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
      document.getElementById('import-btn').addEventListener('click', () => {
        const file = document.getElementById('import-file').files[0];
        if (!file) {
          showStatus('error', 'âŒ ãƒ•ã‚¡ã‚¤ãƒ«ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“');
          return;
        }

        const reader = new FileReader();
        reader.onload = async (e) => {
          try {
            const data = JSON.parse(e.target.result);
            await chrome.storage.local.set(data);
            showStatus('success', 'âœ… ã‚¤ãƒ³ãƒãƒ¼ãƒˆå®Œäº†');
            setTimeout(() => location.reload(), 1000);
          } catch (error) {
            showStatus('error', 'âŒ ã‚¤ãƒ³ãƒãƒ¼ãƒˆå¤±æ•—: ' + error.message);
          }
        };
        reader.readAsText(file);
      });

      // å…¨ãƒ‡ãƒ¼ã‚¿å‰Šé™¤
      document.getElementById('clear-data-btn').addEventListener('click', async () => {
        if (confirm('æœ¬å½“ã«å…¨ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å…ƒã«æˆ»ã›ã¾ã›ã‚“ã€‚')) {
          try {
            await chrome.storage.local.clear();
            showStatus('success', 'âœ… å…¨ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
            setTimeout(() => location.reload(), 1000);
          } catch (error) {
            showStatus('error', 'âŒ å‰Šé™¤å¤±æ•—: ' + error.message);
          }
        }
      });

      // è¨­å®šå¤‰æ›´æ™‚ã®è‡ªå‹•ä¿å­˜
      ['enable-notifications', 'monitoring-interval', 'auto-backup'].forEach(id => {
        document.getElementById(id).addEventListener('change', saveSettings);
      });
    }

    async function saveSettings() {
      try {
        const settings = {
          enable_notifications: document.getElementById('enable-notifications').checked,
          monitoring_interval: parseInt(document.getElementById('monitoring-interval').value),
          auto_backup_enabled: document.getElementById('auto-backup').checked
        };

        await chrome.storage.local.set({ wodicon_settings: settings });
        showStatus('success', 'âœ… è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸ', 2000);
      } catch (error) {
        showStatus('error', 'âŒ è¨­å®šä¿å­˜å¤±æ•—: ' + error.message);
      }
    }

    function showStatus(type, message, duration = 3000) {
      const statusDiv = document.getElementById('import-export-status');
      statusDiv.className = `status ${type}`;
      statusDiv.textContent = message;
      
      setTimeout(() => {
        statusDiv.textContent = '';
        statusDiv.className = 'status';
      }, duration);
    }

    // ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±è¡¨ç¤º
    document.getElementById('version').textContent = chrome.runtime.getManifest().version;
  </script>
</body>
</html>